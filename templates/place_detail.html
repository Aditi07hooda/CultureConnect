<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ place['name'] }} Details</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Culture Connect</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse mt-2" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('about') }}">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('contact') }}">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container_place mt-4">
      <div class="row">
        <div class="col-md-6">
          <h1>{{ place['name'] }}</h1>
          <p><strong>Location:</strong> {{ place['Location'] }}</p>
          <p><strong>Type:</strong> {{ place['Type'] }}</p>
          <p><strong>Activities:</strong> {{ place['Activities'] }}</p>
          <p><strong>Best Season:</strong> {{ place['Best Season'] }}</p>
          <p><strong>Description:</strong> {{ place['description'] }}</p>
          <p><strong>Festival:</strong> {{ place['festival'] }}</p>
          <p>
            <strong>No of People Visited:</strong> {{ place['No of People
            Visited'] }}
          </p>
          <p>
            <strong>Price per Night:</strong> ${{ place['price per night'] }}
          </p>
          <p><strong>Rating:</strong> {{ place['Rating'] }}</p>
          <a href="{{ url_for('index') }}" class="btn btn-secondary"
            >Back to Home</a
          >
          <button
            type="button"
            class="btn btn-success"
            data-bs-toggle="modal"
            data-bs-target="#bookingModal"
          >
            Book Now
          </button>
        </div>
        <div class="col-md-6">
          <img
            src="{{ place['image'] }}"
            class="img-fluid"
            alt="{{ place['name'] }}"
          />
        </div>
      </div>
    </div>

    <div class="mx-4 mt-3">
      <h2>Similar Places</h2>
      <div class="row">
        {% for similar_place in similar_places %}
        <div class="col-md-3 mb-4">
          <div class="card">
            <img
              src="{{ similar_place['image'] }}"
              class="card-img-top"
              alt="{{ similar_place['name'] }}"
            />
            <div class="card-body">
              <h5 class="card-title">{{ similar_place['name'] }}</h5>
              <p class="card-text">
                <strong>Location:</strong> {{ similar_place['Location'] }}<br />
                <strong>Type:</strong> {{ similar_place['Type'] }}<br />
                <strong>Price:</strong> ${{ similar_place['price per night']
                }}<br />
                <strong>Rating:</strong> {{ similar_place['Rating'] }}<br />
              </p>
              <a
                href="{{ url_for('page_detail', place_id=similar_place['place_id']) }}"
                class="btn btn-primary"
                >View Details</a
              >
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div
      class="modal fade"
      id="bookingModal"
      tabindex="-1"
      aria-labelledby="bookingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bookingModalLabel">
              Book {{ place['name'] }}
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="bookingForm">
              <input
                type="hidden"
                id="userId"
                name="user_id"
                value="{{ session['user_id'] }}"
              />
              <input
                type="hidden"
                id="placeId"
                name="place_id"
                value="{{ place['place_id'] }}"
              />
              <input
                type="hidden"
                id="placeName"
                name="place_name"
                value="{{ place['name'] }}"
              />
              <div class="mb-3">
                <label for="checkInDate" class="form-label"
                  >Check-in Date</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="checkInDate"
                  name="check_in_date"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="checkOutDate" class="form-label"
                  >Check-out Date</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="checkOutDate"
                  name="check_out_date"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="guests" class="form-label">Number of Guests</label>
                <input
                  type="number"
                  class="form-control"
                  id="guests"
                  name="guests"
                  min="1"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="totalPrice" class="form-label">Total Price</label>
                <input
                  type="text"
                  class="form-control"
                  id="totalPrice"
                  name="total_price"
                  readonly
                />
              </div>
              <button type="submit" class="btn btn-success">
                Confirm Booking
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      const checkInDateInput = document.getElementById("checkInDate");
      const checkOutDateInput = document.getElementById("checkOutDate");
      const guestsInput = document.getElementById("guests");
      const totalPriceInput = document.getElementById("totalPrice");

      // Event listeners to recalculate total price
      checkInDateInput.addEventListener("change", calculateTotalPrice);
      checkOutDateInput.addEventListener("change", calculateTotalPrice);
      guestsInput.addEventListener("input", calculateTotalPrice);

      function calculateTotalPrice() {
        const pricePerNight = {{ place['price per night'] }}; // From template
        const guests = parseInt(guestsInput.value) || 0;

        const checkInDate = new Date(checkInDateInput.value);
        const checkOutDate = new Date(checkOutDateInput.value);
        const days = (checkOutDate - checkInDate) / (1000 * 60 * 60 * 24);

        if (days > 0 && guests > 0) {
          const totalPrice = guests * pricePerNight * days;
          totalPriceInput.value = totalPrice; // Set calculated price
        } else {
          totalPriceInput.value = ""; // Clear if invalid
        }
      }

      document.getElementById("bookingForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const data = {
          user_id: document.getElementById("userId").value,
          place_id: document.getElementById("placeId").value,
          place_name: document.getElementById("placeName").value,
          check_in_date: checkInDateInput.value,
          check_out_date: checkOutDateInput.value,
          total_price: totalPriceInput.value,
          guests: guestsInput.value,
        };

        fetch("/book", {
          method: "POST",
          body: JSON.stringify(data),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.message) {
              alert(data.message);
              location.reload(); // Optionally reload
            } else {
              alert("Booking failed: " + data.error);
            }
          })
          .catch((error) => console.error("Error:", error));
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
